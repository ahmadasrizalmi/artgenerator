import React, { useState, useEffect } from 'react';

// --- Konstanta untuk Pilihan Gaya ---
const artStyleOptions = [
  { value: 'Watercolor - Bright & Detailed', label: 'Watercolor - Cerah & Detail' },
  { value: 'Watercolor - Vibrant & Whimsical', label: 'Watercolor - Berwarna & Unik' },
  { value: 'Impressionistic Oil/Acrylic - Atmospheric & Warm', label: 'Impresionis - Atmosfer & Hangat' },
];

const colorPaletteOptions = [
  { value: 'Warm & Earthy Tones with Vibrant Accents', label: 'Nada Hangat & Bumi dengan Aksen Cerah' },
  { value: 'Bright & Contrasting Hues', label: 'Warna Cerah & Kontras' },
  { value: 'Rich Sunset/Twilight Hues', label: 'Warna Senja/Malam Hari yang Kaya' },
];

const textureDetailOptions = [
  { value: 'Soft Brushstrokes, Moderate Detail', label: 'Sapuan Kuas Halus, Detail Sedang' },
  { value: 'Loose Brushwork, Simplified Details', label: 'Sapuan Kuas Bebas, Detail Sederhana' },
  { value: 'Bold Color Blocks, Impressionistic Details', label: 'Blok Warna Berani, Detail Impresionis' },
];

const lightingMoodOptions = [
  { value: 'Bright Daylight, Peaceful Atmosphere', label: 'Siang Hari Cerah, Suasana Tenang' },
  { value: 'Sunny & Lively, Cheerful Mood', label: 'Cerah & Hidup, Suasana Ceria' },
  { value: 'Golden Hour/Night Glow, Romantic/Melancholic Ambiance', label: 'Jam Emas/Cahaya Malam, Suasana Romantis' },
];

const backgroundOption = [
  { value: 'original', label: 'Gunakan Latar Belakang Asli' },
  { value: 'remove', label: 'Fokus pada Objek (Hapus Latar Belakang)' },
];

/**
 * Komponen SelectGroup untuk membuat dropdown pilihan
 */
const SelectGroup = ({ label, id, value, onChange, options }) => (
  <div className="w-full">
    <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">
      {label}
    </label>
    <select
      id={id}
      value={value}
      onChange={(e) => onChange(e.target.value)}
      className="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
    >
      <option value="">Pilih {label.toLowerCase()}...</option>
      {options.map((option) => (
        <option key={option.value} value={option.value}>
          {option.label}
        </option>
      ))}
    </select>
  </div>
);

/**
 * Komponen LoadingSpinner
 */
const LoadingSpinner = () => (
  <div className="flex flex-col items-center justify-center">
    <svg className="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <span className="mt-2 text-gray-600">Sedang memproses gambar Anda...</span>
  </div>
);

/**
 * Fungsi helper untuk mengonversi Base64 ke Blob URL
 */
const base64ToBlobUrl = (base64DataUrl) => {
  try {
    const base64 = base64DataUrl.split(',')[1];
    if (!base64) throw new Error("Format Data URL tidak valid");

    const byteCharacters = atob(base64);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
      byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    const blob = new Blob([byteArray], { type: 'image/png' });
    return URL.createObjectURL(blob);
  } catch (e) {
    console.error("Gagal mengonversi Base64 ke Blob URL:", e);
    return null;
  }
};

/**
 * Komponen utama Aplikasi
 */
export default function App() {
  const [uploadedImage, setUploadedImage] = useState(null);
  const [uploadedImageUrl, setUploadedImageUrl] = useState(null);
  const [generatedImage, setGeneratedImage] = useState(null);
  const [downloadUrl, setDownloadUrl] = useState(null); // <-- STATE BARU UNTUK LINK UNDUH
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);

  // State untuk menyimpan pilihan pengguna
  const [artStyle, setArtStyle] = useState('');
  const [colorPalette, setColorPalette] = useState('');
  const [textureDetail, setTextureDetail] = useState('');
  const [lightingMood, setLightingMood] = useState('');
  const [backgroundChoice, setBackgroundChoice] = useState('original'); // Default ke 'original'

  // Membersihkan URL objek lama saat komponen unmount atau gambar berubah
  useEffect(() => {
    // Pastikan untuk membersihkan URL objek sebelumnya untuk menghindari kebocoran memori
    const currentUploadedImageUrl = uploadedImageUrl;
    const currentDownloadUrl = downloadUrl;
    
    return () => {
      if (currentUploadedImageUrl) {
        URL.revokeObjectURL(currentUploadedImageUrl);
      }
      if (currentDownloadUrl) {
        URL.revokeObjectURL(currentDownloadUrl);
      }
    };
  }, [uploadedImageUrl, downloadUrl]); // Tambahkan downloadUrl ke dependensi
  
  // Fungsi untuk membersihkan state unduhan sebelumnya
  const cleanupOldDownload = () => {
    if (downloadUrl) {
      URL.revokeObjectURL(downloadUrl);
      setDownloadUrl(null);
    }
    setGeneratedImage(null);
  };

  // Fungsi untuk menangani unggahan file
  const handleImageUpload = (event) => {
    const file = event.target.files[0];
    if (file && file.type.startsWith('image/')) {
      if (uploadedImageUrl) {
        URL.revokeObjectURL(uploadedImageUrl);
      }
      cleanupOldDownload(); // Bersihkan unduhan lama
      setError(null);
      
      setUploadedImage(file);
      const newImageUrl = URL.createObjectURL(file);
      setUploadedImageUrl(newImageUrl);
    } else {
      setError('Silakan unggah file gambar yang valid (JPG, PNG, WEBP).');
      setUploadedImage(null);
      setUploadedImageUrl(null);
    }
  };

  // Fungsi untuk konversi File ke Base64
  const convertFileToBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => {
        const base64Data = reader.result.split(',')[1];
        resolve(base64Data);
      };
      reader.onerror = (error) => reject(error);
    });
  };

  // Fungsi untuk memanggil API dengan retry logic sederhana
  const fetchWithRetry = async (url, options, retries = 3, delay = 1000) => {
    for (let i = 0; i < retries; i++) {
      try {
        const response = await fetch(url, options);
        if (response.ok) {
          return response.json();
        }
        if (response.status === 429 || response.status >= 500) {
          console.warn(`Attempt ${i + 1} failed with status ${response.status}. Retrying in ${delay}ms...`);
          await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
        } else {
          const errorData = await response.json();
          throw new Error(errorData.error?.message || `Error ${response.status}`);
        }
      } catch (error) {
        if (i === retries - 1) throw error;
        console.warn(`Attempt ${i + 1} failed with error: ${error.message}. Retrying...`);
        await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
      }
    }
  };


  // Fungsi untuk menghasilkan gambar
  const handleGenerateImage = async () => {
    if (!uploadedImage || !artStyle || !colorPalette || !textureDetail || !lightingMood || !backgroundChoice) {
      setError('Harap unggah gambar dan lengkapi semua pilihan gaya.');
      return;
    }

    setIsLoading(true);
    setError(null);
    cleanupOldDownload(); // Bersihkan unduhan dan gambar lama

    try {
      const base64ImageData = await convertFileToBase64(uploadedImage);
      const mimeType = uploadedImage.type;

      let prompt = `
        Ubah gambar yang diunggah ini menggunakan gaya berikut.
        Gambar Asli: [disertakan]
        Instruksi Gaya:
        - Gaya Artistik: ${artStyle}
        - Palet Warna: ${colorPalette}
        - Tekstur & Detail: ${textureDetail}
        - Pencahayaan & Suasana: ${lightingMood}
      `;

      if (backgroundChoice === 'remove') {
        prompt += `
        - Latar Belakang: Fokus pada objek utama. Hapus atau minimalkan latar belakang asli dan ganti dengan latar belakang netral atau sederhana yang sesuai dengan gaya artistik yang dipilih, atau jadikan transparan jika memungkinkan.
        `;
      } else {
        prompt += `
        - Latar Belakang: Pertahankan dan ubah latar belakang asli sesuai dengan gaya artistik yang dipilih.
        `;
      }
      prompt += `
        Hasilkan gambar baru berdasarkan gambar asli dan instruksi gaya ini.
      `;

      const apiKey = "";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

      const payload = {
        contents: [{
          parts: [
            { text: prompt },
            {
              inlineData: {
                mimeType: mimeType,
                data: base64ImageData
              }
            }
          ]
        }],
        generationConfig: {
          responseModalities: ["IMAGE"]
        },
      };

      const result = await fetchWithRetry(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if (!result || !result.candidates || !result.candidates[0] || !result.candidates[0].content || !result.candidates[0].content.parts) {
          let errorMessage = 'Respons AI tidak valid atau kosong.';
          if (result && result.promptFeedback) {
              errorMessage = `Gambar diblokir karena: ${result.promptFeedback.blockReason || 'Alasan tidak diketahui'}`;
          } else if (result && result.candidates && result.candidates[0] && result.candidates[0].finishReason) {
               errorMessage = `Proses dihentikan karena: ${result.candidates[0].finishReason}`;
          }
          console.error("Respons API tidak valid:", result);
          setError(errorMessage);
          setIsLoading(false); 
          return;
      }

      const base64Data = result.candidates[0].content.parts.find(p => p.inlineData)?.inlineData?.data;

      if (base64Data) {
        const dataUrl = `data:image/png;base64,${base64Data}`;
        setGeneratedImage(dataUrl);
        // --- LOGIKA BARU ---
        // Langsung buat Blob URL untuk diunduh
        const blobUrl = base64ToBlobUrl(dataUrl);
        if (blobUrl) {
          setDownloadUrl(blobUrl);
        } else {
          setError("Gagal membuat link unduhan.");
        }
        // --- AKHIR LOGIKA BARU ---
      } else {
        const textResponse = result.candidates[0].content.parts.find(p => p.text)?.text;
        console.error("Tidak ada data gambar di respons:", result);
        setError(`AI merespons dengan teks, bukan gambar: "${textResponse || 'Tidak ada data gambar.'}"`);
      }

    } catch (error) {
      console.error('Error generating image:', error);
      setError(`Terjadi kesalahan: ${error.message || 'Tidak dapat terhubung ke server.'}`);
    } finally {
      setIsLoading(false);
    }
  };

  const isGenerateButtonDisabled = !uploadedImage || !artStyle || !colorPalette || !textureDetail || !lightingMood || !backgroundChoice || isLoading;

  return (
    <div className="bg-gray-50 min-h-screen text-gray-900 font-sans p-4 md:p-8">
      <div className="max-w-7xl mx-auto">
        {/* --- Header --- */}
        <header className="text-center mb-8">
          <h1 className="text-3xl md:text-4xl font-bold text-blue-700">Editor Foto AI Artistik</h1>
          <p className="text-lg text-gray-600 mt-2">Unggah fotomu dan ubah menjadi karya seni!</p>
        </header>

        <div className="md:grid md:grid-cols-2 md:gap-8">
          {/* --- Kolom Kontrol (Kiri) --- */}
          <div className="bg-white p-6 rounded-lg shadow-lg space-y-6 h-fit mb-8 md:mb-0">
            {/* 1. Unggah Gambar */}
            <div>
              <label htmlFor="file-upload" className="w-full inline-block bg-green-600 text-white text-center font-semibold py-3 px-4 rounded-lg cursor-pointer hover:bg-green-700 transition-colors duration-300">
                {uploadedImage ? `Gambar Dipilih: ${uploadedImage.name}` : '1. Unggah Gambar Anda'}
              </label>
              <input
                id="file-upload"
                type="file"
                accept="image/*"
                className="hidden"
                onChange={handleImageUpload}
              />
              <p className="text-xs text-gray-500 mt-2 text-center">Format yang didukung: JPG, PNG, WEBP</p>
            </div>

            {/* 2-6. Pilihan Gaya */}
            <SelectGroup
              label="2. Gaya Artistik"
              id="art-style"
              value={artStyle}
              onChange={setArtStyle}
              options={artStyleOptions}
            />
            <SelectGroup
              label="3. Palet Warna"
              id="color-palette"
              value={colorPalette}
              onChange={setColorPalette}
              options={colorPaletteOptions}
            />
            <SelectGroup
              label="4. Tekstur & Detail"
              id="texture-detail"
              value={textureDetail}
              onChange={setTextureDetail}
              options={textureDetailOptions}
            />
            <SelectGroup
              label="5. Pencahayaan & Suasana"
              id="lighting-mood"
              value={lightingMood}
              onChange={setLightingMood}
              options={lightingMoodOptions}
            />
            <SelectGroup
              label="6. Pilihan Latar Belakang"
              id="background-choice"
              value={backgroundChoice}
              onChange={setBackgroundChoice}
              options={backgroundOption}
            />

            {/* 7. Tombol Generate */}
            <button
              onClick={handleGenerateImage}
              disabled={isGenerateButtonDisabled}
              className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 ease-in-out
                         hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
                         disabled:bg-gray-400 disabled:cursor-not-allowed disabled:shadow-none
                         shadow-md hover:shadow-lg transform disabled:transform-none hover:-translate-y-0.5"
            >
              {isLoading ? 'Sedang Memproses...' : 'Hasilkan Karya Seni!'}
            </button>
            
            {error && (
              <div className="mt-4 p-3 bg-red-100 border border-red-300 text-red-800 rounded-md text-sm break-words">
                <strong>Error:</strong> {error}
              </div>
            )}
          </div>

          {/* --- Kolom Tampilan Gambar (Kanan) --- */}
          <div className="space-y-8">
            {/* Pratinjau Gambar Asli */}
            <div className="bg-white p-4 rounded-lg shadow-lg">
              <h3 className="text-xl font-semibold text-gray-700 mb-3">Gambar Asli</h3>
              <div className="w-full min-h-[250px] md:min-h-[300px] bg-gray-100 rounded-md flex items-center justify-center border border-gray-200 overflow-hidden">
                {uploadedImageUrl ? (
                  <img src={uploadedImageUrl} alt="Pratinjau Unggahan" className="max-w-full h-auto max-h-[500px] object-contain rounded-md" />
                ) : (
                  <p className="text-gray-500">Pratinjau gambar akan muncul di sini</p>
                )}
              </div>
            </div>

            {/* Hasil Gambar AI */}
            <div className="bg-white p-4 rounded-lg shadow-lg">
              <h3 className="text-xl font-semibold text-gray-700 mb-3">Hasil Edit AI</h3>
              <div className="w-full min-h-[250px] md:min-h-[300px] bg-gray-100 rounded-md flex items-center justify-center border border-gray-200 overflow-hidden">
                {isLoading ? (
                  <LoadingSpinner />
                ) : generatedImage ? (
                  <img src={generatedImage} alt="Hasil Edit AI" className="max-w-full h-auto max-h-[500px] object-contain rounded-md" />
                ) : (
                  <p className="text-gray-500 text-center p-4">Hasil editan AI akan muncul di sini setelah Anda menekan tombol 'Hasilkan'.</p>
                )}
              </div>
              
              {/* --- BAGIAN UNDUH YANG DIPERBAIKI --- */}
              {/* Ini sekarang adalah tautan <a> yang diberi gaya seperti tombol.
                Ini hanya muncul jika proses tidak loading DAN downloadUrl (state baru) sudah siap.
              */}
              {!isLoading && downloadUrl && (
                <div className="mt-4 text-center">
                  <a
                    href={downloadUrl}
                    download="edited-image.png"
                    className="inline-block bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2"
                  >
                    Unduh Gambar
                  </a>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

